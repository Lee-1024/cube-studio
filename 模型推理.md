# 域名访问

config.py中配置SERVICE_DOMAIN变量为泛域名

客户端->istio-ingressgate（VirtualService）-> k8s service->k8s pod

# ip:port访问

config.py中配置SERVICE_EXTERNAL_IP=[xx.xx.xx.xx] 或者项目组中配置SERVICE_EXTERNAL_IP=xx.xx.xx.xx，ip需为集群中节点的ip或者clb的ip

客户端 -> k8s service external ip -> k8s pod


# 版本/域名/pod/ip的关系

`$服务名=$服务类型-$模型名-$模型版本(只取版本中的数字)`

![image](https://user-images.githubusercontent.com/20157705/175967987-b64cdd63-14ba-4586-b9a2-9caacfc2492b.png)

`$k8s-deploymnet-name=$服务名`

![image](https://user-images.githubusercontent.com/20157705/175971533-3e973bab-94c3-469b-95aa-41ca7d24806c.png)

`$k8s-hpa-name=$服务名`

在最大最小副本数不一致时创建hpa

![image](https://user-images.githubusercontent.com/20157705/175971605-0753996b-d2a1-4b4f-89c1-38f369382969.png)

`$k8s-service-name=$服务名`  用于域名的代理

`$k8s-service-name=$服务名-external`   用户ip的代理

![image](https://user-images.githubusercontent.com/20157705/175971660-c94a2c23-a6fb-4c7f-ba07-673e85e4dfe4.png)

`$ip:port=$代理服务ip:20000+10*id`

<img width="1640" alt="image" src="https://user-images.githubusercontent.com/20157705/175973458-229bd11f-c0de-4566-9c75-871491186db7.png">


# 系统自带域名

需要泛域名支持，这里假如泛域名为kfserving.woa.com

生产域名

http://$服务名.service.kfserving.woa.com

测试环境域名

http://test.$服务名.service.kfserving.woa.com

http://debug.$服务名.service.kfserving.woa.com

# 自定义域名

用户可通过host字段配置服务的访问域名

多个服务可以配置相同的域名

# 流量复制和分流

多个服务（可以是相同模型或者不同模型间）配置相同的域名

1、分流属性字段控制分配多少流量到其他服务上，剩余流量归属于当前服务

2、流量镜像字段控制复制多少流量到其他服务上。但只会将当前服务的响应返回给客户端

![image](https://user-images.githubusercontent.com/20157705/175974879-a78a0266-e57f-4e5c-9a42-47eddc039008.png)

# 灰度升级

1、同一个服务灰度升级，只需要修改服务的配置，重新部署，服务会自动滚动升级pod

2、不同服务进行灰度升级。比如同一个模型的不同版本之间，那么多个服务使用相同的域名，新部署的服务上线正常后，会自动下线同域名的旧服务。

# 弹性伸缩容

弹性伸缩容的触发条件：可以使用自定义指标，可以使用其中一个指标或者多个指标，示例：cpu:50%,mem:%50,gpu:50%

# 环境变量

系统携带的环境变量
```
KUBEFLOW_ENV=test
KUBEFLOW_MODEL_PATH=
KUBEFLOW_MODEL_VERSION=
KUBEFLOW_MODEL_IMAGES=
KUBEFLOW_MODEL_NAME=
KUBEFLOW_AREA=shanghai/guangzhou

K8S_NODE_NAME=
K8S_POD_NAMESPACE=
K8S_POD_IP=
K8S_HOST_IP=
K8S_POD_NAME=
```



